# 共识算法
共识算法是分布式系统中对于某件事达成相同认知的算法，可用于构建高可用的分布式系统。典型的共识算法有Paxos、Raft、Zab等

## Raft
Raft是斯坦福Diego教授在2014年提出的共识算法，它的目标是提供更清晰的逻辑分工使得算法本身能被更好地理解。Raft算法将共识问题划分为三个子问题：领导选举、日记复制、安全性。

### Raft基础
Raft是一种复制状态机协议，每台服务器拥有三种状态：Leader、Candidate、Follower。状态之间的转化如下图所示

![image](https://user-images.githubusercontent.com/79254572/179355883-d15e4e33-dfb9-4923-b32f-6e4c3d546bdc.png)

Raft把时间分割成任意长度的任期，每个任期内只有一个领导，也可能没有领导（此时会快速触发选举超时，一般能在5s内选举新的leader）。Raft服务器之间的通信RPC实现，基本的共识算法只需要两种RPC：RequestVote RPCs和AppendEntries RPCs。

### 领导选举
Raft 使用一种心跳机制来触发领导人选举，当一段时间没有受到来自Leader的心跳时，此时服务器会触发选举超时，认为Leader可能已经宕机了，于是触发新的一轮选举。
这时候该服务器会将自己状态转化为候选者，更改任期，并给自己投一票，然后并行地向其它服务器发送投票请求。当它获得超过半数选票时便可以成为新的Leader，然后并行地向其它服务器发送心跳告知自己成为Leader。值得注意的是，投票过程中，当一台服务器的日记比请求投票的服务器的日记还要新时，此时不会投票给该服务器，因为需要维护日记的一致性（新的Leader必须具备前Leader所有已经提交的日记）。投票过程中可能由于网络延迟收到过期的请求，此时直接忽略即可。如果选举过程遇到来自新Leader的心跳，则将自己变成Follower。为了避免选票分裂的情况，每台的服务器的选举超时时间是150-300ms之间的随机数。

### 日记复制
日记复制是Raft算法的重点，当选举出Leader时，Leader负责处理来自客户端的请求，客户端的每条请求指令加上任期编号组成的序列就是所谓的日记。Leader会将自身的日记定期追加给集群中的其它服务器。由于各种网络故障，集群中有的服务器可能缺失部分日记，有的可能拥有冗余未提交的日记。当追加日记失败时，Leader会不断尝试直到追加成功。当遇到日记冲突时，Leader会截断冲突的日记，因为Leader无法判断该日记是否已经被之前的Leader提交。当日记已经复制到集群中的大部分机器时，此时日记才会被提交并应用到状态机。日记复制的核心在于数据流只能从Leader流向Follower。

![image](https://user-images.githubusercontent.com/79254572/179357020-eeb3aa4d-37ab-431d-8e49-941c7d49cf3d.png)

Raft维护的日记特征：

1. 如果在不同的日志中的两个条目拥有相同的索引和任期号，那么他们存储了相同的指令。

2. 如果在不同的日志中的两个条目拥有相同的索引和任期号，那么他们之前的所有日志条目也全部相同

### 安全性
维护不同的状态机拥有相同的指令序列，通过增加额外的约束来实现

1. 选举约束
投票人会拒绝掉那些日志没有自己新的投票请求。Raft 通过比较两份日志中最后一条日志条目的索引值和任期号定义谁的日志比较新。如果两份日志最后的条目的任期号不同，那么任期号大的日志更加新。如果两份日志最后的条目任期号相同，那么日志索引比较大的日记更加新。通过施加这样的约束，可以保证新的Leader一定拥有所有已提交的日记。

2. 提交日记约束
Leader只能提交当前任期的日记，不能提交上一任期的日记。因为Leader无法判断出该日记是否已经被提交。Leader只能通过提交当前任期的日记间接提交上一任期的日记

![image](https://user-images.githubusercontent.com/79254572/179357681-84911f4d-2e6a-47f1-a060-34f6f3bbc630.png)


## Paxos


## Zab
